# R Markdown static Databricks app

Minimal Databricks app that serves static content generated by R Markdown. FastAPI mounts the static directory at `/` and exposes `/api` for future use.

## R dependencies (renv)

The project uses [renv](https://rstudio.github.io/renv/) for reproducible R dependencies. Key packages (e.g. `rmarkdown`, `knitr`) are listed in `renv.lock`.

**Pandoc** is also required (rmarkdown uses it to build HTML). Install if needed:

- **macOS:** `brew install pandoc`
- **Windows:** `choco install pandoc` or [pandoc.org/installing](https://pandoc.org/installing.html)
- **Linux:** `sudo apt install pandoc` or `sudo yum install pandoc`
- **Databricks:** Pandoc is usually available on the runtime; if not, install it in the cluster or use a custom image.

- **RStudio:** Open the project (File → Open Project → choose this directory). renv will activate and prompt to run `renv::restore()` to install packages from the lockfile.
- **Shell / other editors:** From the repo root run `Rscript -e "renv::restore()"` to install the project library from `renv.lock`.

After restore (and with Pandoc installed), `source("render_report.R")` will use the project’s R Markdown environment.

## 1. Render the report

Output is written as `index.html` so the app’s root URL serves the report.

### RStudio

1. Open the project (renv will activate; run `renv::restore()` if prompted).
2. Working directory should be the repo root.
3. Run:
   ```r
   source("render_report.R")
   ```
   Output goes to `static/` by default.

To output to a specific directory:
```r
render_report("path/to/output")
# or
Sys.setenv(STATIC_OUTPUT_DIR = "path/to/output")
source("render_report.R")
```

### Databricks notebook

1. Put `report.Rmd` and `render_report.R` in the workspace (e.g. clone repo or upload to a folder).
2. In a cell, set the working directory to that folder and run:
   ```r
   setwd("/Workspace/Users/your@email/path/to/rmd-static-dbx-app")  # or your path
   source("render_report.R")
   ```
   This writes to `static/` in that folder.

To render into a Unity Catalog volume (so the app can serve it without redeploying):
```r
Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog_name/schema_name/volume_name")
source("render_report.R")
```

From the shell (e.g. job step):
```bash
Rscript render_report.R /Volumes/catalog_name/schema_name/volume_name
```

## 2. Run the app locally

```bash
pip install -r requirements.txt
uvicorn app:app --reload
```

Open http://127.0.0.1:8000 for the static page and http://127.0.0.1:8000/api/v1/healthcheck for the health check.

## 3. Deploy as a Databricks app

Use the **`vending-machine`** CLI profile for your workspace.

**Prerequisites**

- [Databricks CLI](https://docs.databricks.com/en/dev-tools/cli/index.html) installed and a profile configured (e.g. `databricks configure --profile vending-machine`).
- App code in a **workspace folder**. The deploy command expects a **workspace path** (e.g. `/Workspace/Users/you@company/rmd-static-dbx-app`), not a local path like `.`. Put the code in the workspace first (see below).

**Steps**

1. **Render the report** so `static/` contains `index.html`:
   ```bash
   Rscript render_report.R
   ```

2. **Upload the project to the workspace** (pick one):
   - **Repos:** Clone this repo in Databricks (Repos → Add Repo → your Git URL). Use the repo path as the source (e.g. `/Repos/you@company/rmd-static-dbx-app`).
   - **CLI:** Create a folder and upload the current directory:
     ```bash
     databricks workspace mkdirs /Workspace/Users/your@email/rmd-static-dbx-app --profile vending-machine
     databricks workspace import_dir . /Workspace/Users/your@email/rmd-static-dbx-app --profile vending-machine
     ```
     Replace the path with your workspace path.

3. **Create the app** (once per app name):
   ```bash
   databricks apps create rmd-static-app --profile vending-machine
   ```
   Use a unique name (lowercase letters, numbers, hyphens). If you see "App with name ... does not exist" when deploying, create the app first with this command.

4. **Deploy** using the **workspace path** as source (not a local path):
   ```bash
   databricks apps deploy rmd-static-app --profile vending-machine --source-code-path /Workspace/Users/your@email/rmd-static-dbx-app
   ```
   Or, if the app source is already set in the UI, you can run:
   ```bash
   databricks apps deploy rmd-static-app --profile vending-machine
   ```

**Important:** Deploy copies the **contents of your source folder** as-is. The app serves `/` from `static/index.html`, so that file must exist in the source. The repo includes a placeholder `static/index.html` (it is **not** in `.gitignore`). If you previously had `static/index.html` ignored, add and commit it, then re-deploy so the app has something to serve. For the full report, run `Rscript render_report.R` before uploading/deploying (or run it in a workspace notebook and re-deploy).

The deployed app will serve the static page at `/` and the health check at `/api/v1/healthcheck`.

## 4. Update static content without redeploying (volume)

To change the report by updating files only (no app redeploy):

1. Create a Unity Catalog volume in your workspace.
2. In the Databricks Apps UI, add that volume as an app resource with key **`volume`**.
3. In `app.yaml`, uncomment the `env` block so `STATIC_CONTENT_PATH` uses `valueFrom: volume`.
4. Render the report into that volume from a notebook or job:
   ```r
   Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog/schema/volume_name")
   source("render_report.R")
   ```
5. Redeploy the app once (so it gets the volume resource). After that, re-run the render (or a scheduled job that runs `render_report.R` into the volume) to refresh the page; no need to redeploy the app again.
