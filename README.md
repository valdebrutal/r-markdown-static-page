# R Markdown static Databricks app

Minimal Databricks app that serves static content generated by R Markdown. FastAPI mounts the static directory at `/` and exposes `/api` for future use.

## 1. Render the report

Output is written as `index.html` so the appâ€™s root URL serves the report.

### RStudio

1. Open the project and set working directory to the repo root.
2. Install dependencies if needed: `install.packages("rmarkdown")`.
3. Run:
   ```r
   source("render_report.R")
   ```
   Output goes to `static/` by default.

To output to a specific directory:
```r
render_report("path/to/output")
# or
Sys.setenv(STATIC_OUTPUT_DIR = "path/to/output")
source("render_report.R")
```

### Databricks notebook

1. Put `report.Rmd` and `render_report.R` in the workspace (e.g. clone repo or upload to a folder).
2. In a cell, set the working directory to that folder and run:
   ```r
   setwd("/Workspace/Users/your@email/path/to/rmd-static-dbx-app")  # or your path
   source("render_report.R")
   ```
   This writes to `static/` in that folder.

To render into a Unity Catalog volume (so the app can serve it without redeploying):
```r
Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog_name/schema_name/volume_name")
source("render_report.R")
```

From the shell (e.g. job step):
```bash
Rscript render_report.R /Volumes/catalog_name/schema_name/volume_name
```

## 2. Run the app locally

```bash
pip install -r requirements.txt
uvicorn app:app --reload
```

Open http://127.0.0.1:8000 for the static page and http://127.0.0.1:8000/api/v1/healthcheck for the health check.

## 3. Deploy as a Databricks app

Use the **`vending-machine`** CLI profile for the target workspace:

```bash
databricks apps deploy --profile vending-machine
```

Ensure the app directory includes a populated `static/` (e.g. run `render_report.R` first) so the deployed app has an `index.html` to serve. The `/api` prefix is mounted for future token-based auth or API routes.

## 4. Update static content without redeploying (volume)

To change the report by updating files only (no app redeploy):

1. Create a Unity Catalog volume in your workspace.
2. In the Databricks Apps UI, add that volume as an app resource with key **`volume`**.
3. In `app.yaml`, uncomment the `env` block so `STATIC_CONTENT_PATH` uses `valueFrom: volume`.
4. Render the report into that volume from a notebook or job:
   ```r
   Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog/schema/volume_name")
   source("render_report.R")
   ```
5. Redeploy the app once (so it gets the volume resource). After that, re-run the render (or a scheduled job that runs `render_report.R` into the volume) to refresh the page; no need to redeploy the app again.
