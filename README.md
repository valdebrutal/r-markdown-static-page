# R Markdown static Databricks app

Minimal Databricks app that serves static content generated by R Markdown. FastAPI mounts the static directory at `/` and exposes `/api` for future use.

## R dependencies (renv)

The project uses [renv](https://rstudio.github.io/renv/) for reproducible R dependencies. Key packages (e.g. `rmarkdown`, `knitr`) are listed in `renv.lock`.

**Pandoc** is also required (rmarkdown uses it to build HTML). Install if needed:

- **macOS:** `brew install pandoc`
- **Windows:** `choco install pandoc` or [pandoc.org/installing](https://pandoc.org/installing.html)
- **Linux:** `sudo apt install pandoc` or `sudo yum install pandoc`
- **Databricks:** Pandoc is usually available on the runtime; if not, install it in the cluster or use a custom image.

- **RStudio:** Open the project (File → Open Project → choose this directory). renv will activate and prompt to run `renv::restore()` to install packages from the lockfile.
- **Shell / other editors:** From the repo root run `Rscript -e "renv::restore()"` to install the project library from `renv.lock`.

After restore (and with Pandoc installed), `source("render_report.R")` will use the project’s R Markdown environment.

## 1. Render the report

Output is written as `index.html` so the app’s root URL serves the report.

### RStudio

1. Open the project (renv will activate; run `renv::restore()` if prompted).
2. Working directory should be the repo root.
3. Run:
   ```r
   source("render_report.R")
   ```
   Output goes to `static/` by default.

To output to a specific directory:
```r
render_report("path/to/output")
# or
Sys.setenv(STATIC_OUTPUT_DIR = "path/to/output")
source("render_report.R")
```

### Databricks notebook

1. Put `report.Rmd` and `render_report.R` in the workspace (e.g. clone repo or upload to a folder).
2. In a cell, set the working directory to that folder and run:
   ```r
   setwd("/Workspace/Users/your@email/path/to/rmd-static-dbx-app")  # or your path
   source("render_report.R")
   ```
   This writes to `static/` in that folder.

To render into a Unity Catalog volume (so the app can serve it without redeploying):
```r
Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog_name/schema_name/volume_name")
source("render_report.R")
```

From the shell (e.g. job step):
```bash
Rscript render_report.R /Volumes/catalog_name/schema_name/volume_name
```

## 2. Run the app locally

```bash
pip install -r requirements.txt
uvicorn app:app --reload
```

Open http://127.0.0.1:8000 for the static page and http://127.0.0.1:8000/api/v1/healthcheck for the health check.

## 3. Deploy as a Databricks app

Use the **`vending-machine`** CLI profile for your workspace.

**Prerequisites**

- [Databricks CLI](https://docs.databricks.com/en/dev-tools/cli/index.html) installed and a profile named `vending-machine` configured (`databricks configure --profile vending-machine`).
- App code in a **workspace folder** (e.g. upload this repo or sync it to something like `/Workspace/Users/your@email/rmd-static-dbx-app`).

**Steps**

1. **Render the report** so `static/` contains `index.html` (otherwise the app has nothing to serve at `/`):
   ```bash
   Rscript render_report.R
   ```
2. **Create the app once** (if it doesn’t exist yet):
   ```bash
   databricks apps create rmd-static-app --profile vending-machine
   ```
   Use any name that’s unique in the workspace (lowercase letters, numbers, hyphens).
3. **Point the app at your project folder**  
   In the Databricks UI: **Apps** → your app → **Settings** → set **Source** to the workspace path that contains `app.py`, `app.yaml`, `requirements.txt`, and `static/`.
4. **Deploy** (builds, installs deps, runs the app):
   ```bash
   databricks apps deploy --profile vending-machine
   ```
   If you have multiple apps, specify the app name or ensure the CLI is targeting the right app (e.g. by running from the same context or using the app ID in the command if required by your CLI version).

The deployed app will serve the static page at `/` and the health check at `/api/v1/healthcheck`.

## 4. Update static content without redeploying (volume)

To change the report by updating files only (no app redeploy):

1. Create a Unity Catalog volume in your workspace.
2. In the Databricks Apps UI, add that volume as an app resource with key **`volume`**.
3. In `app.yaml`, uncomment the `env` block so `STATIC_CONTENT_PATH` uses `valueFrom: volume`.
4. Render the report into that volume from a notebook or job:
   ```r
   Sys.setenv(STATIC_OUTPUT_DIR = "/Volumes/catalog/schema/volume_name")
   source("render_report.R")
   ```
5. Redeploy the app once (so it gets the volume resource). After that, re-run the render (or a scheduled job that runs `render_report.R` into the volume) to refresh the page; no need to redeploy the app again.
